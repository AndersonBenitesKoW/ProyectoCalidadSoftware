@model CapaEntidad.entParto

@{
    ViewData["Title"] = "Registro de Parto";
}

<h1 class="display-6">@ViewData["Title"]</h1>
<p class="lead text-muted">Complete los campos para registrar un nuevo parto en el sistema.</p>
<hr />

<form asp-action="RegistrarParto" method="post" class="needs-validation" novalidate>

    @* Token de seguridad para formularios POST *@
    @Html.AntiForgeryToken()

    @* Muestra de Errores Generales (de la Capa Lógica o Conexión) *@
    @if (ViewBag.MensajeError != null)
    {
        <div class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @ViewBag.MensajeError
        </div>
    }

    <div class="card shadow-sm mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-person-check-fill me-2"></i>Paso 1: Seleccionar Paciente y Encuentro</h5>
        </div>
        <div class="card-body bg-light">
            <div class="row g-3">
                <div class="col-md-6">
                    <label asp-for="IdEmbarazo" class="form-label fw-bold">Embarazo (Paciente)</label>
                    <select asp-for="IdEmbarazo" class="form-select" asp-items="@ViewBag.ListaEmbarazos" id="embarazoDropdown" required>
                        <option value="">-- Seleccione un Embarazo Activo --</option>
                    </select>
                    <span asp-validation-for="IdEmbarazo" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="IdEncuentro" class="form-label fw-bold">Encuentro (Intraparto)</label>
                    <select asp-for="IdEncuentro" class="form-select" id="encuentroDropdown" disabled required>
                        <option value="">-- Primero seleccione un embarazo --</option>
                    </select>
                    <span asp-validation-for="IdEncuentro" class="text-danger"></span>
                </div>
            </div>
        </div>
    </div>


    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-file-earmark-text me-2"></i>Paso 2: Datos Generales del Parto</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">

                <div class="col-md-6">
                    <label asp-for="Fecha" class="form-label">Fecha del Parto</label>
                    <input asp-for="Fecha" type="date" class="form-control" asp-format="{0:yyyy-MM-dd}" required />
                    <span asp-validation-for="Fecha" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="IdProfesional" class="form-label">Profesional que Atiende</label>
                    <select asp-for="IdProfesional" class="form-select" asp-items="@ViewBag.ListaProfesionales" required>
                        <option value="">-- Seleccione un Profesional --</option>
                    </select>
                    <span asp-validation-for="IdProfesional" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="HoraIngreso" class="form-label">Hora de Ingreso</label>
                    <input asp-for="HoraIngreso" type="datetime-local" class="form-control" />
                    <span asp-validation-for="HoraIngreso" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="HoraInicioTrabajo" class="form-label">Hora Inicio de Trabajo de Parto</label>
                    <input asp-for="HoraInicioTrabajo" type="datetime-local" class="form-control" />
                    <span asp-validation-for="HoraInicioTrabajo" class="text-danger"></span>
                </div>

            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-heart-pulse-fill me-2"></i>Paso 3: Detalles Clínicos</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">

                <div class="col-md-4">
                    <label asp-for="Membranas" class="form-label">Membranas</label>
                    <select asp-for="Membranas" class="form-select" required>
                        <option value="">-- Seleccione --</option>
                        <option value="Rotas">Rotas</option>
                        <option value="Íntegras">Íntegras</option>
                    </select>
                    <span asp-validation-for="Membranas" class="text-danger"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="IdLiquido" class="form-label">Líquido Amniótico</label>
                    <select asp-for="IdLiquido" class="form-select" asp-items="@ViewBag.ListaLiquidos" required>
                        <option value="">-- Seleccione --</option>
                    </select>
                    <span asp-validation-for="IdLiquido" class="text-danger"></span>
                </div>

                <div class="col-md-4">
                    <label asp-for="IdViaParto" class="form-label">Vía del Parto</label>
                    <select asp-for="IdViaParto" class="form-select" asp-items="@ViewBag.ListaViasParto" required>
                        <option value="">-- Seleccione --</option>
                    </select>
                    <span asp-validation-for="IdViaParto" class="text-danger"></span>
                </div>

                <div class="col-md-6">
                    <label asp-for="Analgesia" class="form-label">Analgesia (Opcional)</label>
                    <input asp-for="Analgesia" type="text" class="form-control" />
                </div>

                <div class="col-md-6">
                    <label asp-for="PerdidasML" class="form-label">Pérdida Sanguínea (mL) (Opcional)</label>
                    <input asp-for="PerdidasML" type="number" class="form-control" />
                </div>

                <div class="col-md-12">
                    <label asp-for="Desgarro" class="form-label">Desgarro (Grado/Tipo) (Opcional)</label>
                    <input asp-for="Desgarro" type="text" class="form-control" />
                </div>

                <div class="col-md-12">
                    <label asp-for="IndicacionCesarea" class="form-label">Indicación de Cesárea (si aplica)</label>
                    <textarea asp-for="IndicacionCesarea" class="form-control" rows="2"></textarea>
                </div>

                <div class="col-md-12">
                    <label asp-for="Complicaciones" class="form-label">Complicaciones (Opcional)</label>
                    <textarea asp-for="Complicaciones" class="form-control" rows="2"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-scissors me-2"></i>Paso 4: Intervenciones Realizadas (Opcional)</h5>
        </div>
        <div class="card-body">
            <div id="intervenciones-container">
            </div>
            <button type="button" id="btn-add-intervencion" class="btn btn-outline-primary btn-sm mt-2">
                <i class="bi bi-plus-lg me-1"></i> Agregar Intervención
            </button>
        </div>
    </div>

    <div class="mt-4 mb-5 text-end">
        <a asp-action="Index" asp-controller="Parto" class="btn btn-secondary me-2">
            <i class="bi bi-x-circle me-2"></i>Cancelar
        </a>
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-save me-2"></i>Registrar Parto
        </button>
    </div>

</form>

@* Scripts de validación de formulario *@
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function () {

            var embarazoSelect = $('#embarazoDropdown');
            var encuentroSelect = $('#encuentroDropdown');

            if (embarazoSelect.val()) {
                cargarEncuentros(embarazoSelect.val());
            }

            embarazoSelect.on('change', function () {
                var idEmbarazoSeleccionado = $(this).val();
                encuentroSelect.empty().append('<option value="">-- Cargando... --</option>');

                if (idEmbarazoSeleccionado) {
                    cargarEncuentros(idEmbarazoSeleccionado);
                } else {
                    encuentroSelect.empty().append('<option value="">-- Primero seleccione un embarazo --</option>').prop('disabled', true);
                }
            });

            function cargarEncuentros(idEmbarazo) {
                var url = '@Url.Action("GetEncuentros", "Parto")?idEmbarazo=' + idEmbarazo;
                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function (data) {
                        encuentroSelect.empty();
                        encuentroSelect.prop('disabled', false);

                        if (data && data.length > 0) {
                            encuentroSelect.append('<option value="">-- Seleccione un encuentro --</option>');
                            $.each(data, function (i, item) {
                                encuentroSelect.append($('<option>', {
                                    value: item.value,
                                    text: item.text
                                }));
                            });
                        } else {
                            encuentroSelect.append('<option value="">-- No hay encuentros (Intraparto) para este embarazo --</option>');
                        }
                    },
                    error: function () {
                        alert('Error al cargar los encuentros.');
                        encuentroSelect.empty().append('<option value="">-- Error al cargar --</option>').prop('disabled', true);
                    }
                });
            }
        });
    </script>

    <script>
        document.getElementById('btn-add-intervencion').addEventListener('click', function () {
            var container = document.getElementById('intervenciones-container');
            var div = document.createElement('div');
            div.className = 'input-group mb-2 shadow-sm';

            var input = document.createElement('input');
            input.type = 'text';
            input.name = 'intervenciones'; // ¡Importante!
            input.className = 'form-control';
            input.placeholder = 'Ej: Episiotomía';
            input.required = true;

            var btnRemove = document.createElement('button');
            btnRemove.type = 'button';
            btnRemove.className = 'btn btn-outline-danger';
            btnRemove.innerHTML = '<i class="bi bi-trash-fill"></i>'; // Icono de basura
            btnRemove.title = 'Eliminar';
            btnRemove.onclick = function() {
                div.remove();
            };

            div.appendChild(input);
            div.appendChild(btnRemove);
            container.appendChild(div);
            input.focus(); // Poner el foco en el nuevo input
        });
    </script>
}